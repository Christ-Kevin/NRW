<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <meta name="Timo Breilmann 6026144" content="Autor" />
        <meta name="Christoph Evensen 6051080" content="Autor" />
        <title>Kartographische Informationsverarbeitung</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link
            rel="stylesheet"
            href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
        />
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet/dist/leaflet.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
        />
    </head>

    <body>
        <!-- Füge die Leaflet-Bibliothek hinzu -->
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <!-- Füge die Leaflet.markercluster-Bibliothek hinzu -->
        <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

        <aside id="wappen">
            <img
                src="medien/Logo_JadeHochschule_7.jpg"
                style="height: 100%"
                alt="Jade HS Wappen"
            />
        </aside>
        <header id="kopf">
            <h1><a href="index.html">ÖPNV in Oldenburg</a></h1>
        </header>
        <nav id="navigation">
            <ul>
                <li><a href="index2.html">Infos</a></li>
            </ul>
        </nav>
        <main id="inhalt">
            <h2>Startseite</h2>
            <h4>Interaktive Karte</h4>
            <section class="ui-widget" style="text-align: left">
                <input id="autocomplete" placeholder="Gebäude: " />
                <input id="stopsAutocomplete" placeholder="Haltestopp: " />
            </section>
            <section id="map"></section>
            <script>
                // Definieren der JSON-Dateien und zweier Hilfsarrays
                var gebaeude_shapes = "Buildings.geojson";
                var lines_OePNV = "OePNV_Lines.geojson";
                var stops_OePNV = "OePNV_Stops.geojson";
                var arr = [];
                var arrAkb = [];
                var arrVName = [];
                var arrStopNames = [];

                // Initialisierung der Karte
                var map = L.map("map").setView([53.141092, 8.215208], 12);
                var osm = new L.tileLayer(
                    "http://{s}.tile.osm.org/{z}/{x}/{y}.png",
                    {
                        attribution:
                            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    }
                );
                osm.addTo(map);

                // Erstellen Sie eine LayerGroup für den GeoJSON-Layer
                var oepnv_layer = L.layerGroup();
                fetch(lines_OePNV)
                    .then((response) => response.json())
                    .then((data) => {
                        // Erstellen Sie ein Leaflet GeoJSON layer und fügen Sie es der LayerGroup hinzu
                        L.geoJSON(data, {
                            style: function () {
                                return {
                                    color: getRandomColor(),
                                    weight: 2,
                                    opacity: 1,
                                };
                            },
                        }).addTo(oepnv_layer);
                        oepnv_layer.addTo(map);
                    })
                    .catch((error) =>
                        console.error("Error fetching GeoJSON:", error)
                    );
                // Funktion, um eine zufällige Farbe zu generieren
                function getRandomColor() {
                    var letters = "0123456789ABCDEF";
                    var color = "#";
                    for (var i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }

                // Erstelle einen Markercluster-Gruppen-Layer mit benutzerdefinierten Optionen
                var stops_layer = L.markerClusterGroup({
                    maxClusterRadius: 50, // Ändere dies entsprechend deinen Bedürfnissen
                    disableClusteringAtZoom: 25, // Ändere dies entsprechend deinen Bedürfnissen
                });
                var selectedMarker = null; // Variable zum Speichern des zuletzt ausgewählten Markers
                fetch(stops_OePNV)
                    .then((response) => response.json())
                    .then((data) => {
                        // Erstelle ein Leaflet GeoJSON layer und füge es der Cluster-Gruppe hinzu
                        L.geoJSON(data, {
                            pointToLayer: function (feature, latlng) {
                                var circleMarker = L.circleMarker(latlng, {
                                    radius: 5,
                                    fillColor: "red",
                                    color: "black",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 1,
                                });

                                // Extrahiere den Haltestellennamen und füge ihn dem Array hinzu
                                var stopName = feature.properties.stop_name;
                                arrStopNames.push(stopName);

                                // Popup-Inhalt erstellen
                                var popupContent = `
                                    <b>${feature.properties.stop_name}</b><br>
                                    Stop ID: ${feature.properties.stop_id}`;

                                // Popup zum Marker binden
                                circleMarker.bindPopup(popupContent);

                                circleMarker.on("click", function (e) {
                                    // Zurücksetzen der vorherigen Auswahl
                                    if (selectedMarker) {
                                        selectedMarker.setStyle({
                                            fillColor: "red",
                                        });
                                    }
                                    // Setzen der neuen Auswahl
                                    circleMarker.setStyle({
                                        fillColor: "green",
                                    });
                                    // Speichern des ausgewählten Markers
                                    selectedMarker = circleMarker;
                                });
                                return circleMarker;
                            },
                        }).addTo(stops_layer);

                        // Initialisiere das Stops-Autocomplete-Widget mit dem neuen Array
                        $("#stopsAutocomplete").autocomplete({
                            source: function (request, response) {
                                var stopResults = $.ui.autocomplete.filter(
                                    arrStopNames,
                                    request.term
                                );
                                response(stopResults.slice(0, 10));
                            },
                            select: function (event, ui) {
                                stopSelect(ui.item.label);
                                ui.item.value = "";
                            },
                        });
                        // Füge die Cluster-Gruppe der Karte hinzu
                        stops_layer.addTo(map);
                    })
                    .catch((error) =>
                        console.error("Error fetching GeoJSON:", error)
                    );

                // Initialisierung des JQuery autocomplete Widget mit einem leeren Element (Wird erst geladen wenn die JSON Datei eingelesen wurde)
                $("#autocomplete").autocomplete({
                    source: function (request, response) {
                        var results = $.ui.autocomplete.filter(
                            arr,
                            request.term
                        );
                        response(results.slice(0, 10)); // Begrenzt auf die ersten 10 Ergebnisse
                    },
                    select: function (event, ui) {
                        polySelect(ui.item.label);
                    },
                });

                // Eine Style Funktion die die Farbe der Polygone der JSON Datei füllt
                function style(feature) {
                    // Grundfarbe der Polygone.
                    return {
                        fillColor: "green",
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 1,
                        color: "#ffffff",
                        dashArray: "3",
                    };
                }
                var highlight = {
                    // Farbe des Polygons wenn es ausgewählt wird.
                    fillColor: "red",
                    weight: 2,
                    opacity: 1,
                };
                function forEachFeature(feature, layer) {
                    // Der Name des jeweiligen Polygons im Datensatz wird für die Suche getagged
                    layer._leaflet_id = feature.properties.Abk;
                    var popupContent =
                        "<p><b>Abkürzung: </b>" +
                        feature.properties.Abk +
                        "<br>Vollständiger Name: " +
                        feature.properties.vName +
                        "</p>";
                    layer.bindPopup(popupContent);
                    layer.on("click", function (e) {
                        gebaeude_layer.setStyle(style); //setzt die Farbe des Layers
                        layer.setStyle(highlight); //setzt die Farbe wenn ausgewählt
                    });
                }
                // Mit JQuery wird die GeoJSON-Datei in den Layer geladen, bevor dieser zur Karte hinzugefügt wird.
                // Wenn das Array durchgelaufen ist, wird es zur addDataToAutocomplete Funktion übergeben.
                var gebaeude_layer = L.geoJson(null, {
                    onEachFeature: forEachFeature,
                    style: style,
                });

                $.getJSON(gebaeude_shapes, function (data) {
                    gebaeude_layer.addData(data);
                    for (i = 0; i < data.features.length; i++) {
                        // Lädt die Abkürzungen ins Array für die Suche.
                        arrAkb.push({
                            label: data.features[i].properties.Abk,
                            value: "", //data.features[i].properties.vName
                        });
                        // Lädt die vollständigen Namen ins Array für die Suche.
                        arrVName.push({
                            label: data.features[i].properties.vName,
                            value: "", //data.features[i].properties.Abk
                        });
                    }
                    // Kombiniere beide Arrays zu einem einzigen Array
                    var combinedArray = arrAkb.concat(arrVName);

                    // Gib das kombinierte Array an die Funktion für das Sortieren und das Laden der Suchkontrolle weiter.
                    addDataToAutocomplete(combinedArray);
                });
                gebaeude_layer.addTo(map);
                // Autocomplete-Suche
                function addDataToAutocomplete(arr) {
                    arr.sort(function (a, b) {
                        var nameA = a.label + " " + a.value,
                            nameB = b.label + " " + b.value;
                        return nameA.localeCompare(nameB);
                    });

                    $("#autocomplete").autocomplete("option", "source", arr);

                    $("#autocomplete").on(
                        "autocompleteselect",
                        function (event, ui) {
                            polySelect(ui.item.label);
                            ui.item.value = "";
                        }
                    );
                }

                function stopSelect(searchTerm) {
                    stops_layer.eachLayer(function (layer) {
                        if (layer instanceof L.MarkerCluster) {
                            layer
                                .getAllChildMarkers()
                                .forEach(function (marker) {
                                    if (
                                        marker.feature.properties.stop_name ===
                                        searchTerm
                                    ) {
                                        stops_layer.zoomToShowLayer(
                                            marker,
                                            function () {
                                                map.setView(
                                                    marker.getLatLng(),
                                                    16
                                                );
                                                // Ändere die Farbe des Punkts
                                                marker.setStyle({
                                                    fillColor: "green",
                                                });

                                                // Setze Timeout, um sicherzustellen, dass die Karte korrekt gerendert wurde
                                                setTimeout(function () {
                                                    // Manuell Popup öffnen
                                                    marker.openPopup();
                                                }, 300); // Sie können die Zeit anpassen, falls nötig
                                            }
                                        );
                                    }
                                });
                        } else if (
                            layer instanceof L.CircleMarker &&
                            layer.feature.properties.stop_name === searchTerm
                        ) {
                            map.setView(layer.getLatLng(), 16);

                            // Ändere die Farbe des Punkts
                            layer.setStyle({
                                fillColor: "green",
                            });
                            // Setze Timeout, um sicherzustellen, dass die Karte korrekt gerendert wurde
                            setTimeout(function () {
                                // Manuell Popup öffnen
                                layer.openPopup();
                            }, 300); // Sie können die Zeit anpassen, falls nötig
                        } else {
                            // Setze den Stil für alle anderen CircleMarker zurück
                            layer.setStyle({
                                fillColor: "red", // Setze die Farbe auf die ursprüngliche Farbe
                            });
                        }
                    });
                }

                function polySelect(searchTerm) {
                    for (var layerId in map._layers) {
                        if (map._layers.hasOwnProperty(layerId)) {
                            var layer = map._layers[layerId];
                            if (
                                layer instanceof L.Path &&
                                layer.feature.properties.Abk === searchTerm
                            ) {
                                map.fitBounds(layer.getBounds());
                                layer.fire("click");
                                return;
                            }
                            // Hier prüfen, ob der vollständige Name übereinstimmt
                            if (
                                layer instanceof L.Path &&
                                layer.feature.properties.vName === searchTerm
                            ) {
                                map.fitBounds(layer.getBounds());
                                layer.fire("click");
                                return;
                            }
                        }
                    }
                }
                // Layer-control.
                var baseMaps = {
                    "Open Street Map": osm,
                };
                var overlayMaps = {
                    Buildings: gebaeude_layer,
                    Lines_OePNV: oepnv_layer,
                    Stops_OePNV: stops_layer,
                };
                // Hinzufügen des Layer-control's
                L.control.layers(baseMaps, overlayMaps).addTo(map);
            </script>
            <a id="download" href="Buildings.geojson" download
                >Download GeoJson-Datei für die Gebäude</a
            >
        </main>
        <footer id="fusszeile">
            <ul>
                <li><a href="kontakt.html">Kontakt</a></li>
                <li><a href="impressum.html">Impressum</a></li>
            </ul>
        </footer>
    </body>
</html>
