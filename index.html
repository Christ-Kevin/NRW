<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="Timo Breilmann 6026144" content="Autor" />
        <meta name="Christoph Evensen 6051080" content="Autor" />
        <title>Kartographische Informationsverarbeitung</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <link
            rel="stylesheet"
            href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
        />
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        />
    </head>

    <body>
        <aside id="wappen">
            <img
                src="medien/Logo_JadeHochschule_7.jpg"
                style="height: 100%"
                alt="Jade HS Wappen"
            />
        </aside>
        <header id="kopf">
            <h1><a href="index.html">ÖPNV in Oldenburg</a></h1>
        </header>
        <nav id="navigation">
            <ul>
                <li><a href="infos.html">Infos</a></li>
            </ul>
        </nav>
        <main id="inhalt">
            <h2>Startseite</h2>
            <h4>Interaktive Karte</h4>
            <section class="ui-widget" style="text-align: left">
                <input
                    id="autocomplete"
                    placeholder="Suche nach dem Gebäude: "
                />
            </section>
            <section id="map"></section>
            <script>
                // Definieren der JSON-Dateien und zweier Hilfsarrays
                // var urlNRW = "gemeinden_simplify200.geojson";
                var gebaeude_shapes = "Buildings.geojson";
                var lines_OePNV = "OePNV_Lines.geojson";
                var stops_OePNV = "OePNV_Stops.geojson";
                var arr = [];
                var arrAkb = [];
                var arrVName = [];
                // Erstellen Sie eine LayerGroup für den GeoJSON-Layer
                var linesLayerGroup1 = L.layerGroup();
                fetch(lines_OePNV)
                    .then((response) => response.json())
                    .then((data) => {
                        // Erstellen Sie ein Leaflet GeoJSON layer und fügen Sie es der LayerGroup hinzu
                        L.geoJSON(data, {
                            style: function () {
                                return {
                                    color: getRandomColor(),
                                    weight: 2,
                                    opacity: 1,
                                };
                            },
                        }).addTo(linesLayerGroup1);
                        linesLayerGroup1.addTo(map);
                    })
                    .catch((error) =>
                        console.error("Error fetching GeoJSON:", error)
                    );
                // Funktion, um eine zufällige Farbe zu generieren
                function getRandomColor() {
                    var letters = "0123456789ABCDEF";
                    var color = "#";
                    for (var i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }
                var linesLayerGroup2 = L.layerGroup();
                fetch(stops_OePNV)
                    .then((response) => response.json())
                    .then((data) => {
                        // Erstelle ein Leaflet GeoJSON layer und füge es der Karte hinzu
                        L.geoJSON(data, {
                            pointToLayer: function (feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: 3,
                                    fillColor: "red",
                                    color: "red",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8,
                                });
                            },
                        }).addTo(linesLayerGroup2);
                        linesLayerGroup2.addTo(map);
                    })
                    .catch((error) =>
                        console.error("Error fetching GeoJSON:", error)
                    );
                // Initialisierung des JQuery autocomplete Widget mit einem leeren Element (Wird erst geladen wenn die JSON Datei eingelesen wurde)
                $("#autocomplete").autocomplete();
                // Initialisierung der Karte und der zwei Basemaps
                var map = L.map("map").setView([53.141092, 8.215208], 12);
                var osm = new L.tileLayer(
                    "http://{s}.tile.osm.org/{z}/{x}/{y}.png",
                    {
                        attribution:
                            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    }
                );
                osm.addTo(map);

                // Eine Style Funktion die die Farbe der Polygone der JSON Datei füllt
                function style(feature) {
                    // Grundfarbe der Polygone.
                    return {
                        fillColor: "green",
                        fillOpacity: 0.5,
                        weight: 2,
                        opacity: 1,
                        color: "#ffffff",
                        dashArray: "3",
                    };
                }
                var highlight = {
                    // Farbe des Polygons wenn es ausgewählt wird.
                    fillColor: "red",
                    weight: 2,
                    opacity: 1,
                };
                function forEachFeature(feature, layer) {
                    // Der Name des jeweiligen Polygons im Datensatz wird für die Suche getagged

                    layer._leaflet_id =
                        feature.properties.Abk + "_" + feature.properties.vName;
                    var popupContent =
                        "<p><b>Abkürzung: </b>" +
                        feature.properties.Abk +
                        "<br>Vollständiger Name: " +
                        feature.properties.vName +
                        "</p>";
                    layer.bindPopup(popupContent);
                    layer.on("click", function (e) {
                        stateLayer1.setStyle(style); //setzt die Farbe des Layers
                        layer.setStyle(highlight); //setzt die Farbe wenn ausgewählt
                    });
                    // try {
                    //     layer._leaflet_id = feature.properties.vName;
                    //     var popupContent =
                    //         "<p><b>Abkürzung: </b>" +
                    //         feature.properties.Abk +
                    //         "<br>Vollständiger Name: " +
                    //         feature.properties.vName +
                    //         "</p>";
                    //     layer.bindPopup(popupContent);
                    //     layer.on("click", function (e) {
                    //         stateLayer1.setStyle(style); //setzt die Farbe des Layers
                    //         layer.setStyle(highlight); //setzt die Farbe wenn ausgewählt
                    //     });
                    // } catch (error2) {
                    //     console.error(
                    //         "Sucht nicht nach dem vollständigen Namen:",
                    //         error2
                    //     );
                    // }
                }
                // Mit JQuery wird die GeoJSON-Datei in den Layer geladen, bevor dieser zur Karte hinzugefügt wird.
                // Wenn das Array durchgelaufen ist, wird es zur addDataToAutocomplete Funktion übergeben.
                var stateLayer1 = L.geoJson(null, {
                    onEachFeature: forEachFeature,
                    style: style,
                });
                $.getJSON(gebaeude_shapes, function (data) {
                    stateLayer1.addData(data);
                    for (i = 0; i < data.features.length; i++) {
                        // Lädt die Abkürzungen ins Array für die Suche.
                        arrAkb.push({
                            label: data.features[i].properties.Abk,
                            value: "",
                        });
                        // Lädt die vollständigen Namen ins Array für die Suche.
                        arrVName.push({
                            label: data.features[i].properties.vName,
                            value: "",
                        });
                    }
                    // addDataToAutocomplete(arrAkb); // Gibt das Array für das Sortieren weiter und zum laden der Suchkontrolle.
                    // // addDataToAutocomplete(arrVName);
                    // Kombiniere beide Arrays zu einem einzigen Array
                    var combinedArray = arrAkb.concat(arrVName);

                    // Gib das kombinierte Array an die Funktion für das Sortieren und das Laden der Suchkontrolle weiter.
                    addDataToAutocomplete(combinedArray);
                });
                stateLayer1.addTo(map);

                // Autocomplete-Suche
                function addDataToAutocomplete(arr) {
                    arr.sort(function (a, b) {
                        // Sortiert das Objekt nach Namen
                        var nameA = a.label,
                            nameB = b.label;
                        if (nameA < nameB)
                            // Sortiert den String aufsteigend.
                            return -1;
                        if (nameA > nameB) return 1;
                        return 0; // Wird wieder auf Null gesetzt damit die Suchfunktion bei nächsten mal wieder von vorne anfängt.
                    });
                    // Die Quelle für autocomplete.  https://api.jqueryui.com/autocomplete/#method-option
                    $("#autocomplete").autocomplete("option", "source", arr);
                    $("#autocomplete").on(
                        "autocompleteselect",
                        function (event, ui) {
                            polySelect(ui.item.label); // Nimmt sich die ausgewählte Abkürzung.
                            ui.item.value = "";
                        }
                    );
                } // Autocomplete-Suche wird beendet.

                // Click-Event und Zoom auf das Polygon. Leaflet benutzt eine interne ID um das Polygon auszuwählen.
                function polySelect(selectedLabel) {
                    map._layers[selectedLabel].fire("click"); // 'klickt' auf den Suchbegriff.
                    var layer = map._layers[selectedLabel];
                    map.fitBounds(layer.getBounds()); // Zoomt auf das ausgewählte Polygon.
                }
                // Layer-control.
                var baseMaps = {
                    "Open Street Map": osm,
                };
                var overlayMaps = {
                    Buildings: stateLayer1,
                    Lines_OePNV: linesLayerGroup1,
                    Stops_OePNV: linesLayerGroup2,
                };
                // Hinzufügen des Layer-control's
                L.control.layers(baseMaps, overlayMaps).addTo(map);
            </script>
            <a id="download" href="Buildings.geojson" download
                >Download GeoJson-Datei für die Gebäude</a
            >
        </main>
        <footer id="fusszeile">
            <ul>
                <li><a href="kontakt.html">Kontakt</a></li>
                <li><a href="impressum.html">Impressum</a></li>
            </ul>
        </footer>
    </body>
</html>
