<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="Timo Breilmann 6026144" content="Autor" />
    <meta name="Christoph Evensen 6051080" content="Autor" />
    <title>Kartographische Informationsverarbeitung</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
</head>

<body>
    <aside id="wappen">
        <img src="medien/Logo_JadeHochschule_7.jpg" style="height: 100%" alt="Jade HS Wappen" />
    </aside>
    <header id="kopf">
        <h1><a href="index.html">ÖPNV in Oldenburg</a></h1>
    </header>
    <nav id="navigation">
        <ul>
            <li><a href="index2.html">Infos</a></li>
        </ul>
    </nav>
    <main id="inhalt">
        <h2>Startseite</h2>
        <h4>Interaktive Karte</h4>
        <section class="ui-widget" style="text-align: left">
            <input id="autocomplete" placeholder="Suche nach dem Gebäude: " />
        </section>
        <section id="map"></section>
        <script>
            // Definieren der JSON-Dateien und zweier Hilfsarrays
            var gebaeude_shapes = "Buildings.geojson";
            var lines_OePNV = "OePNV_Lines.geojson";
            var stops_OePNV = "OePNV_Stops.geojson";
            var arr = [];
            var Abk = [];

            // Erstellen Sie eine LayerGroup für den GeoJSON-Layer
            var linesLayerGroup1 = L.layerGroup();
            fetch(lines_OePNV)
                .then((response) => response.json())
                .then((data) => {
                    // Erstellen Sie ein Leaflet GeoJSON layer und fügen Sie es der LayerGroup hinzu
                    L.geoJSON(data, {
                        style: function () {
                            return {
                                color: getRandomColor(),
                                weight: 2,
                                opacity: 1,
                            };
                        },
                    }).addTo(linesLayerGroup1);
                    linesLayerGroup1.addTo(map);
                })
                .catch((error) =>
                    console.error("Error fetching GeoJSON:", error)
                );
            // Funktion, um eine zufällige Farbe zu generieren
            function getRandomColor() {
                var letters = "0123456789ABCDEF";
                var color = "#";
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            var linesLayerGroup2 = L.layerGroup();
            fetch(stops_OePNV)
                .then((response) => response.json())
                .then((data) => {
                    // Erstelle ein Leaflet GeoJSON layer und füge es der Karte hinzu
                    L.geoJSON(data, {
                        pointToLayer: function (feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 3,
                                fillColor: "red",
                                color: "red",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8,
                            });
                        },
                    }).addTo(linesLayerGroup2);
                    linesLayerGroup2.addTo(map);
                })
                .catch((error) =>
                    console.error("Error fetching GeoJSON:", error)
                );
            // Initialisierung des JQuery autocomplete Widget mit einem leeren Element (Wird erst geladen wenn die JSON Datei eingelesen wurde)
            $("#autocomplete").autocomplete({
                source: function (request, response) {
                    var results = $.ui.autocomplete.filter(arr, request.term);
                    response(results.slice(0, 10)); // Begrenzt auf die ersten 10 Ergebnisse
                },
                select: function (event, ui) {
                    polySelect(ui.item.label);
                },
            });

            // Kommentare hier...

            // Initialisierung der Karte und der zwei Basemaps
            var map = L.map("map").setView([53.141092, 8.215208], 12);
            var osm = new L.tileLayer(
                "http://{s}.tile.osm.org/{z}/{x}/{y}.png",
                {
                    attribution:
                        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                }
            );
            osm.addTo(map);

            // Eine Style Funktion die die Farbe der Polygone der JSON Datei füllt
            function style(feature) {
                // Grundfarbe der Polygone.
                return {
                    fillColor: "green",
                    fillOpacity: 0.5,
                    weight: 2,
                    opacity: 1,
                    color: "#ffffff",
                    dashArray: "3",
                };
            }
            var highlight = {
                // Farbe des Polygons wenn es ausgewählt wird.
                fillColor: "red",
                weight: 2,
                opacity: 1,
            };
            function forEachFeature(feature, layer) {
                // Der Name des jeweiligen Polygons im Datensatz wird für die Suche getagged
                layer._leaflet_id = feature.properties.Abk;
                var popupContent =
                    "<p><b>Abkürzung: </b>" +
                    feature.properties.Abk +
                    "<br>Vollständiger Name: " +
                    feature.properties.vName +
                    "</p>";
                layer.bindPopup(popupContent);
                layer.on("click", function (e) {
                    stateLayer1.setStyle(style); //setzt die Farbe des Layers
                    layer.setStyle(highlight); //setzt die Farbe wenn ausgewählt
                });
            }
            // Mit JQuery wird die GeoJSON-Datei in den Layer geladen, bevor dieser zur Karte hinzugefügt wird.
            // Wenn das Array durchgelaufen ist, wird es zur addDataToAutocomplete Funktion übergeben.
            var stateLayer1 = L.geoJson(null, {
                onEachFeature: forEachFeature,
                style: style,
            });

            $.getJSON(gebaeude_shapes, function (data) {
                stateLayer1.addData(data);
                for (i = 0; i < data.features.length; i++) {
                    // Lädt die Abkürzungen ins Array für die Suche.
                    Abk.push({
                        label: data.features[i].properties.Abk,
                        value: data.features[i].properties.vName,
                    });
                    // Lädt die vollständigen Namen ins Array für die Suche.
                    Abk.push({
                        label: data.features[i].properties.vName,
                        value: data.features[i].properties.Abk,
                    });
                }
                addDataToAutocomplete(Abk); // Gibt das Array für das Sortieren weiter und zum Laden der Suchkontrolle.
            });
            stateLayer1.addTo(map);
            // Autocomplete-Suche
            function addDataToAutocomplete(arr) {
                arr.sort(function (a, b) {
                    var nameA = a.label + " " + a.value,
                        nameB = b.label + " " + b.value;
                    return nameA.localeCompare(nameB);
                });

                $("#autocomplete").autocomplete("option", "source", arr);

                $("#autocomplete").on("autocompleteselect", function (event, ui) {
                    polySelect(ui.item.label);
                    ui.item.value = "";
                });
            }

            function polySelect(searchTerm) {
                for (var layerId in map._layers) {
                    if (map._layers.hasOwnProperty(layerId)) {
                        var layer = map._layers[layerId];
                        if (
                            layer instanceof L.Path &&
                            layer.feature.properties.Abk === searchTerm
                        ) {
                            map.fitBounds(layer.getBounds());
                            layer.fire("click");
                            return;
                        }
                        // Hier prüfen, ob der vollständige Name übereinstimmt
                        if (
                            layer instanceof L.Path &&
                            layer.feature.properties.vName === searchTerm
                        ) {
                            map.fitBounds(layer.getBounds());
                            layer.fire("click");
                            return;
                        }
                    }
                }
            }
            // Layer-control.
            var baseMaps = {
                "Open Street Map": osm,
            };
            var overlayMaps = {
                Buildings: stateLayer1,
                Lines_OePNV: linesLayerGroup1,
                Stops_OePNV: linesLayerGroup2,
            };
            // Hinzufügen des Layer-control's
            L.control.layers(baseMaps, overlayMaps).addTo(map);
        </script>
        <a id="download" href="Buildings.geojson" download>Download GeoJson-Datei für die Gebäude</a>
    </main>
    <footer id="fusszeile">
        <ul>
            <li><a href="kontakt.html">Kontakt</a></li>
            <li><a href="impressum.html">Impressum</a></li>
        </ul>
    </footer>
</body>

</html>
